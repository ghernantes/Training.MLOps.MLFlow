FROM continuumio/miniconda3

# Good practice: upgrade distro packages (with last security patches)
RUN apt-get update && apt-get -y upgrade

# Good practice: don't run things in containers as root
RUN useradd --create-home appuser
ENV PATH /home/appuser/.local/bin:${PATH}

USER appuser
# From now on, this process is owned by appuser, and:
# - new software will be installed in: /home/appuser/.conda/envs/fastapi_env/bin$  (e.g. python3 and uvicorn executables):
# (fastapi_env) appuser@6997ec97809e:/opt/conda$ which uvicorn
# /home/appuser/.conda/envs/fastapi_env/bin/uvicorn
# (fastapi_env) appuser@6997ec97809e:/opt/conda$ which python
# /home/appuser/.conda/envs/fastapi_env/bin/python
# - conda packages will be installed in: /home/appuser/.conda/pkgs (e.g. anyio, click, fastapi, ... uvicorn)
# uvicorn is executed as appuser and not as root

# Good practice: install the app under the appuser home folder:
WORKDIR /home/appuser

# Create the environment:
COPY ./app/environment.yml .
RUN conda env create -f environment.yml

# Make RUN commands use the new environment:
RUN echo "conda activate fastapi_env" >> ~/.bashrc
SHELL ["/bin/bash", "--login", "-c"]

# Configure the bash shell properly to use 'conda activate':
# RUN conda init bash
# IMPORTANT: You may need to close and restart your shell after running 'conda init'.
# RUN source ~/anaconda3/etc/profile.d/conda.sh

# Activate the environment, and make sure it's activated:
RUN conda activate fastapi_env

# The code to run when container is started:
COPY ./app/main.py ./app/entrypoint.sh ./
ENTRYPOINT [ "./entrypoint.sh" ]